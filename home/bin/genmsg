#!/bin/bash
# genmsg: Generate a commit message using GitHub Copilot

show_help() {
    cat <<EOF
Usage: genmsg [OPTIONS]

Generate a commit message using GitHub Copilot based on your git changes.

Options:
  --include-untracked, -u   Include untracked files in the commit message suggestion
  --commit, -c              Automatically commit with the generated message
  --all, -a                 Run 'git add .' before committing (only with --commit)
  --help, -h                Show this help message

Examples:
  genmsg
  genmsg --include-untracked
  genmsg --commit
  genmsg --all --commit
EOF
}

if ! command -v gh >/dev/null 2>&1; then
    echo 'Error: GitHub CLI (gh) is not installed. Install with: brew install gh'
    exit 1
fi
TRACKED_ONLY=true
COMMIT=false
ADD_ALL=false
while [ $# -gt 0 ]; do
    case $1 in
        --include-untracked|-u)
            TRACKED_ONLY=false
            shift
            ;;
        --commit|-c)
            COMMIT=true
            shift
            ;;
        --all|-a)
            ADD_ALL=true
            shift
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            show_help
            exit 1
            ;;
    esac
done
if [ "$TRACKED_ONLY" = true ]; then
    if [ -z "$(git diff HEAD)" ]; then
        echo 'No tracked changes detected'
        exit 1
    fi
else
    if [ -z "$(git diff HEAD)" ] && [ -z "$(git ls-files --others --exclude-standard)" ]; then
        echo 'No changes detected'
        exit 1
    fi
fi
echo 'Generating commit message based on changes...'
DIFF_OUTPUT=$(git diff HEAD --unified=0 | head -200)
if [ "$TRACKED_ONLY" != true ]; then
    UNTRACKED=$(git ls-files --others --exclude-standard | paste -sd ',' -)
    if [ -n "$UNTRACKED" ]; then
        DIFF_OUTPUT="diff --git New untracked files to be added: $UNTRACKED"$'\n'"$DIFF_OUTPUT"
    fi
fi
TEMP_FILE=$(mktemp)
printf '\n' | gh copilot suggest -t shell "Write a detailed, multi-line commit message for these changes: $DIFF_OUTPUT" > "$TEMP_FILE" 2>&1
FULL_CMD=$(grep -oE 'git commit.*' "$TEMP_FILE" | head -1)
COMMIT_MSG=$(echo "$FULL_CMD" | sed -n 's/.*git commit -m "\([^"]*\)".*/\1/p')
if [ -z "$COMMIT_MSG" ]; then
    COMMIT_MSG=$(sed -n '/git commit -m "/,/"/p' "$TEMP_FILE" | sed '1s/.*git commit -m "//; $s/".*//; s/^[[:space:]]*//')
fi
rm -f "$TEMP_FILE"
if [ -z "$COMMIT_MSG" ]; then
    echo 'Failed to generate commit message. Using fallback.'
    FIRST_FILE=$(git status --short | head -1 | awk '{print $2}' | xargs basename)
    COMMIT_MSG="chore: update $FIRST_FILE"
fi
echo "Suggested commit message:"
echo "$COMMIT_MSG"
if [ "$COMMIT" = true ]; then
    if [ "$ADD_ALL" = true ]; then
        git add . && git commit -m "$COMMIT_MSG"
    else
        git commit -m "$COMMIT_MSG"
    fi
fi