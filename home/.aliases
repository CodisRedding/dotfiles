# Source klogs functions if the file exists
[ -f "$HOME/dotfiles/home/funcs/klogs.sh" ] && source "$HOME/dotfiles/home/funcs/klogs.sh"

# Function to check dotfiles status (git and Brewfile)
_check_dotfiles_status() {
  local show_success="${1:-false}"
  local in_dotfiles_dir="${2:-false}"
  local check_session_warn="${3:-false}"
  
  if [ "$in_dotfiles_dir" = "false" ]; then
    cd ~/dotfiles
  fi
  
  local issues_found=false
  
  if [[ -d ".git" ]]; then
    changes=$(git status --porcelain | wc -l)
    changes="${changes##*( )}"
    changes="${changes%%*( )}"
    if [ "$changes" -gt 0 ]; then
      # Only show if not checking session warning, or if we haven't warned in this session
      if [ "$check_session_warn" = "false" ] || [[ "$_DOTFILES_RELOAD_WARN" != "$$" ]]; then
        print -P "%F{yellow} $changes uncommitted change(s) in ~/dotfiles. Use 'dotpush'.%f"
        issues_found=true
      fi
    fi
  fi
  
  if ! brew bundle check --file="$HOME/dotfiles/Brewfile" &>/dev/null; then
    print -P "%F{yellow} Your Brewfile is out of sync with installed packages.%f"
    print -P "%F{cyan} Use 'brewupdate' to update your Brewfile, run 'brew outdated' to see what is outdated.%f"
    issues_found=true
  fi
  
  if [ "$show_success" = "true" ] && [ "$issues_found" = "false" ]; then
    print -P "%F{green} âœ“ Dotfiles are up to date - no uncommitted changes and Brewfile is in sync.%f"
  fi
  
  if [ "$in_dotfiles_dir" = "false" ]; then
    cd - > /dev/null
  fi
  
  return $([ "$issues_found" = "true" ] && echo 1 || echo 0)
}

# gitlab cli aliases
# https://gitlab.com/gitlab-org/cli
alias gl='glab' # shortcut for gitlab cli
alias glalias='glab alias' # manage glab aliases
alias glclone='glab repo clone' # clone repository
alias glcompletion='glab completion' # generate shell completion scripts
alias glconfig='glab config' # view or edit glab configuration
alias glgroup='glab group view' # view group
alias glgroupl='glab group list' # list groups
alias glhelp='glab help' # show help for glab
alias glissue='glab issue create' # create issue
alias glissuel='glab issue list' # list issues
alias glissuev='glab issue view' # view issue
alias gllogin='glab auth login' # authenticate with gitlab
alias gllogout='glab auth logout' # logout from gitlab
alias glmr='glab mr create' # create merge request
alias glmrl='glab mr list' # list merge requests
alias glmrm='glab mr merge' # merge request
alias glmrv='glab mr view' # view merge request
alias glpipe='glab ci view' # view pipeline
alias glpipel='glab ci list' # list pipelines
alias glproject='glab project view' # view project
alias glprojectl='glab project list' # list projects
alias glrepo='glab repo view' # view repository
alias glsearch='glab search' # search in gitlab
alias glversion='glab version' # show glab version

# dotfiles directory management
alias dotfiles='cd ~/dotfiles' # navigate to dotfiles directory

alias df='dotfiles' # shortcut to open dotfiles directory
# Check dotfiles status - shows git and Brewfile warnings if needed
alias df-check='_check_dotfiles_status true false'

# Show what changes would be committed in dotfiles using smart commit message
alias df-diff='cd ~/dotfiles && echo "=== Git Status ===" && git status --short && echo && echo "=== Proposed Commit Message ===" && (git genmsg) && cd -'
# Custom Aliases for Zsh

# quick alias to add, commit, and push all changes in dotfiles
alias dotpush='cd ~/dotfiles && git genmsg --commit --all && git push && cd -'

# preview the commit message that dotpush would use without committing
alias dotpush-dryrun='cd ~/dotfiles && git genmsg && cd -'

# quick alias to update Brewfile with current Homebrew/cask/extensions
# Usage: Run 'brewupdate' to update and overwrite Brewfile with your current setup
alias brewupdate='brew update && brew upgrade && brew bundle dump --file=~/dotfiles/Brewfile --force'

## aliases
alias ip='ipconfig getifaddr en0' # get local IP address
## 1Password ssh-agent aliases
# list ssh keys added to the 1Password ssh-agent
alias 1pass-ssh-list='SSH_AUTH_SOCK=~/Library/Group\ Containers/2BUA8C4S2C.com.1password/t/agent.sock ssh-add -l'
# open the 1Password ssh-agent config file
alias 1pass-ssh-config='open ~/.config/1Password/ssh/agent.toml'

# GPG key management
alias gpg-list='gpg --list-secret-keys --keyid-format LONG'
alias gpg-list-all='gpg --list-keys --keyid-format LONG'
alias gpg-github='_gpg_github_format'
alias gpg-gitlab='_gpg_gitlab_format'
alias gpg-find='_gpg_find'
alias gpg-export='_gpg_export'
alias gpg-fingerprint='gpg --fingerprint'

# GPG helper functions
_gpg_github_format() {
    gpg --list-secret-keys --keyid-format LONG | awk '
    /^sec/ {
        # Extract key ID from sec line
        split($2, parts, "/")
        keyid = parts[2]
        stored_keyid = keyid
    }
    /^uid/ {
        # Extract email from uid line and print first with light blue color
        match($0, /<[^>]+>/)
        echo "[DEBUG] Presenting options for commit_msg: $commit_msg"
        if (RSTART) {
            email = substr($0, RSTART+1, RLENGTH-2)
            printf "Email address: \033[94m%s\033[0m\n", email
            print "Key ID: " stored_keyid
        }
        echo "[DEBUG] User selected: $choice"
    }
    /^ssb/ {
        # Extract subkey ID from ssb line
        split($2, parts, "/")
        subkeyid = parts[2]
        print "Subkeys: " subkeyid
        print ""  # Empty line between keys
    }'
}

_gpg_gitlab_format() {
    gpg --list-secret-keys --with-subkey-fingerprints --keyid-format LONG | awk '
    BEGIN { 
        main_fingerprint = ""
        email = ""
        subkey_fingerprints = ""
        processing_main = 0
    }
    /^sec/ {
        processing_main = 1
    }
    /^uid/ {
        # Extract email from uid line
        match($0, /<[^>]+>/)
        if (RSTART) {
            email = substr($0, RSTART+1, RLENGTH-2)
        }
        processing_main = 0
    }
    /^ssb/ {
        processing_main = 0
    }
    /^      [A-F0-9]{40}$/ {
        # This is a fingerprint line (40 hex characters)
        if (processing_main) {
            main_fingerprint = $1
            processing_main = 0
        } else {
            # This is a subkey fingerprint
            if (subkey_fingerprints == "") {
                subkey_fingerprints = $1
            } else {
                subkey_fingerprints = subkey_fingerprints "\n" $1
            }
        }
    }
    END {
        if (email != "" && main_fingerprint != "") {
            printf "Email address: \033[94m%s\033[0m\n", email
            print "Key ID: " main_fingerprint
            if (subkey_fingerprints != "") {
                print "Subkeys: " subkey_fingerprints
            }
            print ""
        }
    }'
}

_gpg_find() {
    if [ $# -eq 0 ]; then
        echo "Usage: gpg-find <email|keyid|name>"
        return 1
    fi
    echo "Searching for: $1"
    gpg --list-secret-keys --keyid-format LONG | grep -i -A 3 -B 1 "$1"
}

_gpg_export() {
    if [ $# -eq 0 ]; then
        echo "Usage: gpg-export <keyid>"
        echo "This will export the public key for adding to GitHub/services"
        return 1
    fi
    echo "Public key for $1:"
    echo "=========================="
    gpg --armor --export "$1"
}

## copilot aliases
# alias to show directory info, git status, and git directories
alias info='echo "Current directory: $(pwd)"; echo; if git rev-parse --is-inside-work-tree &>/dev/null; then echo "This directory is a git repository."; else echo "This directory is NOT a git repository."; fi; echo; echo "Other .git directories under this tree:"; find . -type d -name .git | tee >(wc -l | awk '\''{print "Total: " $1}'\'')'

## ssh aliases
alias ssh-bitbucket="ssh bitbucket.org"
alias ssh-github="ssh github.com"
alias ssh-jenkins="ssh jenkins.premisehealth.com"
alias ssh-extract-api-dev="ssh d-ap-l-extract-02.premisehealth.com"
alias ssh-extract-api-qa="ssh q-ap-l-extract-01.premisehealth.com"
alias ssh-extract-api-prod="ssh p-ap-l-extract-02.premisehealth.com"
alias ssh-extract-db-dev="ssh d-db-tal-01.premisehealth.com"
alias ssh-extract-db-qa="ssh q-db-tal-01.premisehealth.com"
alias ssh-extract-db-prod="ssh p-db-tal-01.premisehealth.com"
alias ssh-paid-web-uat="ssh c-ap-l-paid-01.premisehealth.com"
alias ssh-paid-web-prod="ssh p-ap-l-paid-01.premisehealth.com"
alias ssh-paid-api-uat="ssh c-ap-l-paid-01.premisehealth.com"
alias ssh-paid-api-prod="ssh p-ap-l-paid-01.premisehealth.com"
alias ssh-paid-db-dev="ssh d-db-ph-02.dev-prem-health.com"
alias ssh-paid-db-qa="ssh q-db-ph-02.qua-prem-health.com"
alias ssh-paid-db-uat="ssh c-db-ph-02.premisehealth.com"
alias ssh-paid-db-prod="ssh p-db-ph-02.premisehealth.com"
alias ssh-peap-web-uat="ssh c-wb-l-peap-01.premisehealth.com"
alias ssh-peap-web-prod="ssh p-wb-l-peap-01.premisehealth.com"
alias ssh-peap-api-uat="ssh c-ap-l-peap-01.premisehealth.com"
alias ssh-peap-api-prod="ssh p-ap-l-peap-01.premisehealth.com"
alias ssh-peap-db-dev="ssh d-db-ph-02.dev-prem-health.com"
alias ssh-peap-db-qa="ssh q-db-ph-02.qua-prem-health.com"
alias ssh-peap-db-uat="ssh c-db-ph-02.premisehealth.com"
alias ssh-peap-db-prod="ssh p-db-ph-02.premisehealth.com"
alias ssh-pma-web-uat="ssh c-wb-l-pma-01.premisehealth.com"
alias ssh-pma-web-prod="ssh p-wb-l-pma-01.premisehealth.com"
alias ssh-pma-api-uat="ssh c-ap-l-pma-01.premisehealth.com"
alias ssh-pma-api-uat-t="ssh c-ap-l-pma-01.premisehealth.com"
alias ssh-pma-api-prod="ssh p-ap-l-pma-01.premisehealth.com"
alias ssh-pma-api-prod-t="ssh p-ap-l-pma-01t.premisehealth.com"
alias ssh-pma-db-dev="ssh d-db-ph-02.dev-prem-health.com"
alias ssh-pma-db-qa="ssh q-db-ph-02.qua-prem-health.com"
alias ssh-pma-db-uat="ssh c-db-ph-02.premisehealth.com"
alias ssh-pma-db-prod="ssh p-db-wrhouse-01.premisehealth.com"
alias ssh-ssoproxy-admin-web-uat="ssh c-wb-l-ohmsso-01.premisehealth.com"
alias ssh-ssoproxy-admin-web-prod="ssh p-wb-l-ohmsso-01.premisehealth.com"
alias ssh-ssoproxy-admin-api-uat="ssh c-wb-l-ohmsso-01.premisehealth.com"
alias ssh-ssoproxy-admin-api-prod="ssh p-wb-l-ohmsso-01.premisehealth.com"
alias ssh-ssoproxy-admin-db-dev="ssh d-db-ph-02.dev-prem-health.com"
alias ssh-ssoproxy-admin-db-qa="ssh q-db-ph-02.qua-prem-health.com"
alias ssh-ssoproxy-admin-db-uat="ssh c-db-ph-02.premisehealth.com"
alias ssh-ssoproxy-admin-db-prod="ssh p-db-ph-02.premisehealth.com"
alias ssh-ssoproxy-api-uat="ssh c-wb-l-ohmsso-01.premisehealth.com"
alias ssh-ssoproxy-api-prod="ssh p-wb-l-ohmsso-01.premisehealth.com"
alias ssh-ssoproxy-api-dev-db="ssh d-db-ph-02.dev-prem-health.com"
alias ssh-ssoproxy-api-qa-db="ssh q-db-ph-02.qua-prem-health.com"
alias ssh-ssoproxy-api-uat-db="ssh c-db-ph-02.premisehealth.com"
alias ssh-ssoproxy-api-prod-db="ssh p-db-ph-02.premisehealth.com"

## git aliases
alias groot='cd $(git rev-parse --show-toplevel 2>/dev/null || echo .)' # go to git root
alias glog="git log --graph --pretty=format:'%Cred%h%Creset %an: %s - %Creset %C(yellow)%d%Creset %Cgreen(%cr)%Creset' --abbrev-commit --date=relative" # pretty git log
alias gd='git diff --color | sed "s/^\([^-+ ]*\)[-+ ]/\\1/" | less -r' # colorized git diff in less
alias gs='git status -sb' # upgrade your git if -sb breaks for you. it's fun.
alias gfa='git fetch --all'
alias assume-unchanged='git update-index --assume-unchanged' # use this to ignore local changes to a file
alias assume-changed='git update-index --no-assume-unchanged' # use this to start tracking changes again
alias uncommitted='git diff --name-only' # list uncommitted files
alias last='git log -1 HEAD' # show last commit
alias amend='git commit --amend --no-edit' # quickly amend last commit without changing the message
alias lg='lazygit' # launch lazygit
alias gph='git push origin HEAD' # push current branch to origin (same as git push origin <current-branch>)
alias gmm='git merge master' # merge master into current branch

# termninal recording
alias record='asciinema rec -c "zsh" ~/code/asciinema/$(date +%Y-%m-%d_%H-%M-%S).cast' # record terminal session to a file in ~/code/asciinema
alias play='asciinema play' # play a recorded terminal session
alias listrecords='ls ~/code/asciinema' # list recorded terminal sessions
# Press Ctrl+D (or type exit and press Enter) in the terminal where you started the recording.
alias stoprecord='exit' # stop recording terminal session

# kap
alias kap='open -a Kap' # open kap app

# generate a new GUID and copy it to the clipboard
alias copyApiKey='file=$(find . -name "appsettings.Local.json" -not -path "*/bin/*" -not -path "*/obj/*" -print -quit) && jq -r ".ApiKey" "$file" | tr -d "\n" | tee >(pbcopy) && echo "API key copied to clipboard from $file."'